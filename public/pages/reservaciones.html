<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hotel Paraíso · Reservaciones</title>

    <!-- Estilos base que ya usas -->
    <link rel="stylesheet" href="/public/assets/css/app.css" />
    <link rel="stylesheet" href="/public/assets/css/form.css" />
    <!-- Estilos específicos de reservaciones -->
    <link rel="stylesheet" href="/public/assets/css/reservas.css" />
  </head>
  <body>
    <!-- Topbar -->
    <nav
      class="topbar"
      style="
        background: linear-gradient(90deg, var(--primary-1), var(--primary-2));
      "
    >
      <div class="brand">
        <div class="brand-badge">H</div>
        <div>Hotel&nbsp;Paraíso</div>
      </div>
      <div class="nav-links">
        <a href="/public/index.html">Inicio</a>
        <a href="/public/pages/menu-completo.html">Menú</a>
      </div>
    </nav>

    <!-- Hero “glass” -->
    <header
      class="hero--glass"
      style="
        --hero-bg: url('https://images.pexels.com/photos/258154/pexels-photo-258154.jpeg');
      "
    >
      <div class="glass-card glass-wide">
        <div class="hero-card hero-card--center hero-left">
          <h1 style="margin: 0 0 4px">Reservaciones</h1>
          <p class="muted" style="margin: 0">
            Crea, consulta y administra reservaciones. Disponibilidad en tiempo
            real y calendario.
          </p>
          <div class="kpis">
            <div class="kpi">
              <div class="muted">Ocupación hoy</div>
              <div class="kpi-val">— %</div>
            </div>
            <div class="kpi">
              <div class="muted">Entradas hoy</div>
              <div class="kpi-val">—</div>
            </div>
            <div class="kpi">
              <div class="muted">Salidas hoy</div>
              <div class="kpi-val">—</div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="tab-reservar">
            Reservar
          </button>
          <button class="tab-btn" data-tab="tab-listado">Listado</button>
          <button class="tab-btn" data-tab="tab-disponibilidad">
            Disponibilidad
          </button>
          <div class="right">
            <a class="btn btn-secondary" href="/public/pages/menu-completo.html"
              >← Menú</a
            >
          </div>
        </div>

        <!-- ====== TAB: RESERVAR ====== -->
        <section id="tab-reservar" class="section-card">
          <div class="grid-2">
            <form class="form-grid" id="frmReservar" autocomplete="off">
              <!-- Identificación -->
              <div class="field">
                <label>Cliente</label>
                <select id="r_cliente" required>
                  <option value="">Cargando clientes…</option>
                </select>
              </div>

              <div class="field">
                <label>Habitación</label>
                <select id="r_habitacion" required>
                  <option value="">Cargando habitaciones…</option>
                </select>
              </div>

              <!-- Fechas -->
              <div class="grid-2" style="grid-column: 1/-1">
                <div class="field">
                  <label>Check-in</label>
                  <input type="date" id="r_checkin" required />
                </div>
                <div class="field">
                  <label>Check-out</label>
                  <input type="date" id="r_checkout" required />
                </div>
              </div>

              <!-- Servicios extra -->
              <fieldset class="extras" style="grid-column: 1/-1">
                <legend>Servicios extra (opcional)</legend>
                <div class="extras-grid">
                  <label class="extra-item">
                    <input
                      type="checkbox"
                      class="extra"
                      data-nombre="Desayuno"
                      data-precio="180"
                    />
                    <span>Desayuno buffet</span>
                    <small class="precio">$180</small>
                  </label>
                  <label class="extra-item">
                    <input
                      type="checkbox"
                      class="extra"
                      data-nombre="Spa"
                      data-precio="600"
                    />
                    <span>Acceso Spa</span>
                    <small class="precio">$600</small>
                  </label>
                  <label class="extra-item">
                    <input
                      type="checkbox"
                      class="extra"
                      data-nombre="Transporte"
                      data-precio="350"
                    />
                    <span>Transporte aeropuerto</span>
                    <small class="precio">$350</small>
                  </label>
                  <label class="extra-item">
                    <input
                      type="checkbox"
                      class="extra"
                      data-nombre="Late checkout"
                      data-precio="250"
                    />
                    <span>Late checkout</span>
                    <small class="precio">$250</small>
                  </label>
                </div>
                <p class="muted">
                  * Los montos de extra son por reservación (ejemplo). Si luego
                  quieres manejarlos por noche o por persona, lo ajustamos.
                </p>
              </fieldset>

              <!-- Cálculos -->
              <div class="grid-3" style="grid-column: 1/-1">
                <div class="field">
                  <label>Noches</label>
                  <input id="r_noches" disabled placeholder="—" />
                </div>
                <div class="field">
                  <label>Tarifa estimada (noche)</label>
                  <input id="r_tarifa" disabled placeholder="—" />
                </div>
                <div class="field">
                  <label>Total estimado</label>
                  <input id="r_total" disabled placeholder="—" />
                </div>
              </div>

              <div class="field" style="grid-column: 1/-1">
                <label>Notas (opcional)</label>
                <textarea
                  id="r_notas"
                  rows="3"
                  placeholder="Instrucciones especiales, comentarios…"
                ></textarea>
              </div>

              <div class="actions actions-wrap">
                <button type="button" class="btn btn-secondary" id="btnChecar">
                  Ver disponibilidad
                </button>
                <button type="submit" class="btn btn-primary">Reservar</button>
              </div>
            </form>

            <!-- Preview tipo de habitación -->
            <aside class="preview">
              <img
                id="prev_img"
                src="https://images.pexels.com/photos/271624/pexels-photo-271624.jpeg"
                alt="Tipo de habitación"
              />
              <div class="preview-body">
                <div class="preview-title" id="prev_titulo">Tipo —</div>
                <div class="muted" id="prev_detalle">
                  Capacidad: — · Precio: —
                </div>
                <div class="legend">
                  <span><i class="c-reservada"></i>Reservada</span>
                  <span><i class="c-checkin"></i>En curso</span>
                  <span><i class="c-checkout"></i>Finalizada</span>
                  <span><i class="c-cancelada"></i>Cancelada</span>
                </div>
              </div>
            </aside>
          </div>
        </section>

        <!-- ====== TAB: LISTADO ====== -->
        <section id="tab-listado" class="section-card" style="display: none">
          <div class="tools">
            <div class="field">
              <label>Buscar</label>
              <input id="l_q" placeholder="Folio, cliente, habitación…" />
            </div>
            <div class="field">
              <label>Desde</label>
              <input type="date" id="l_desde" />
            </div>
            <div class="field">
              <label>Hasta</label>
              <input type="date" id="l_hasta" />
            </div>
            <div class="field">
              <label>Estado</label>
              <select id="l_estado">
                <option value="">Todos</option>
                <option>RESERVADA</option>
                <option>CHECKIN</option>
                <option>CHECKOUT</option>
                <option>CANCELADA</option>
              </select>
            </div>
            <button class="btn btn-secondary" id="l_btnBuscar" type="button">
              Buscar
            </button>
            <button class="btn btn-secondary" id="l_btnLimpiar" type="button">
              Limpiar
            </button>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Cliente</th>
                  <th>Hab.</th>
                  <th>Check-in</th>
                  <th>Check-out</th>
                  <th>Noches</th>
                  <th>Total</th>
                  <th>Estado</th>
                  <th style="width: 220px">Acciones</th>
                </tr>
              </thead>
              <tbody id="l_tbody">
                <tr>
                  <td colspan="9" class="muted center">
                    Sin datos (aún sin conectar).
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- ====== TAB: DISPONIBILIDAD ====== -->
        <section
          id="tab-disponibilidad"
          class="section-card"
          style="display: none"
        >
          <div class="tools">
            <div class="field">
              <label>Check-in</label>
              <input type="date" id="d_in" />
            </div>
            <div class="field">
              <label>Check-out</label>
              <input type="date" id="d_out" />
            </div>
            <button class="btn btn-secondary" id="d_btnVer" type="button">
              Ver disponibilidad
            </button>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Hab.</th>
                  <th>Tipo</th>
                  <th>Capacidad</th>
                  <th>Precio</th>
                  <th>Estado</th>
                  <th style="width: 160px">Acción</th>
                </tr>
              </thead>
              <tbody id="d_tbody">
                <tr>
                  <td colspan="6" class="muted center">
                    Sin datos (aún sin conectar).
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- ====== TAB: CALENDARIO ====== -->
        <!-- ====== TAB: CALENDARIO ====== -->
        <section id="tab-calendario" class="section-card" style="display: none">
          <div
            class="tools"
            style="gap: 12px; align-items: end; flex-wrap: wrap"
          >
            <div class="field">
              <label>Año</label>
              <select id="c_anio"></select>
            </div>
            <div class="field">
              <label>Mes</label>
              <select id="c_mes_select"></select>
            </div>

            <div style="display: flex; gap: 8px; align-items: center">
              <button class="btn btn-secondary" id="c_prev" type="button">
                ← Anterior
              </button>
              <button class="btn btn-secondary" id="c_next" type="button">
                Siguiente →
              </button>
              <button class="btn btn-secondary" id="c_btnVer" type="button">
                Ver
              </button>
            </div>
          </div>

          <div class="calendar-shell" id="c_shell">
            Calendario (vista mensual) — aquí se mostrará la ocupación por
            habitación.
          </div>
        </section>
      </div>
    </header>

    <footer class="footer">
      © <span id="y"></span> Hotel Paraíso — Reservaciones
    </footer>

    <script>
      document.getElementById("y").textContent = new Date().getFullYear();

      // Navegación de pestañas (solo UI)
      const tabs = document.querySelectorAll(".tab-btn");
      const sections = {
        "tab-reservar": document.getElementById("tab-reservar"),
        "tab-listado": document.getElementById("tab-listado"),
        "tab-disponibilidad": document.getElementById("tab-disponibilidad"),
        "tab-calendario": document.getElementById("tab-calendario"),
      };
      tabs.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabs.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          Object.values(sections).forEach((s) => (s.style.display = "none"));
          sections[btn.dataset.tab].style.display = "";
        });
      });

      // ---- Cálculo simple en front: noches + extras (estimado) ----
      const $in = document.getElementById("r_checkin");
      const $out = document.getElementById("r_checkout");
      const $noches = document.getElementById("r_noches");
      const $tarifa = document.getElementById("r_tarifa");
      const $total = document.getElementById("r_total");

      const IMG_BY_TIPO = {
        Sencilla:
          "https://images.pexels.com/photos/271624/pexels-photo-271624.jpeg",
        Doble:
          "https://images.pexels.com/photos/271618/pexels-photo-271618.jpeg",
        Suite:
          "https://images.pexels.com/photos/1571459/pexels-photo-1571459.jpeg",
        Familiar:
          "https://images.pexels.com/photos/261102/pexels-photo-261102.jpeg",
      };

      const selHab = document.getElementById("r_habitacion");
      const prevImg = document.getElementById("prev_img");
      const prevTit = document.getElementById("prev_titulo");
      const prevDet = document.getElementById("prev_detalle");

      selHab.addEventListener("change", () => {
        const opt = selHab.selectedOptions[0];
        if (!opt) return;
        const tipo = opt.dataset.tipo || "—";
        const cap = opt.dataset.personas || "—";
        const p = opt.dataset.precio || "";
        prevTit.textContent = `Tipo ${tipo}`;
        prevDet.textContent = `Capacidad: ${cap} · Precio: ${
          p ? "$" + Number(p).toFixed(2) : "—"
        }`;
        if (IMG_BY_TIPO[tipo]) prevImg.src = IMG_BY_TIPO[tipo];
        $tarifa.value = p ? "$" + Number(p).toFixed(2) : "—";
        updateTotal();
      });

      [$in, $out].forEach((i) => i.addEventListener("change", updateTotal));
      document
        .querySelectorAll(".extra")
        .forEach((chk) => chk.addEventListener("change", updateTotal));

      function updateTotal() {
        const dIn = $in.value ? new Date($in.value) : null;
        const dOut = $out.value ? new Date($out.value) : null;
        let noches = 0;
        if (dIn && dOut) {
          noches = Math.max(
            0,
            Math.round((dOut - dIn) / (1000 * 60 * 60 * 24))
          );
        }
        $noches.value = noches || "—";

        const opt = selHab.selectedOptions[0];
        const precio =
          opt && opt.dataset.precio ? Number(opt.dataset.precio) : 0;
        const extras = [...document.querySelectorAll(".extra:checked")].reduce(
          (acc, e) => acc + Number(e.dataset.precio || 0),
          0
        );

        let total = 0;
        if (noches > 0 && precio > 0) {
          total = noches * precio + extras;
        } else if (extras > 0) {
          total = extras;
        }
        $total.value = total > 0 ? "$" + total.toFixed(2) : "—";
      }
    </script>

    <!-- Llenar combos (con auto-preview) -->
    <script>
      async function fillSelect(sel, url) {
        sel.innerHTML = '<option value="">Cargando…</option>';
        try {
          const res = await fetch(url, { headers: { Accept: "text/html" } });
          const html = await res.text();
          sel.innerHTML = html;
          // Por si quedó deshabilitado por algo previo:
          sel.removeAttribute("disabled");
          sel.style.pointerEvents = "auto";
        } catch (e) {
          sel.innerHTML = '<option value="">(Error al cargar)</option>';
        }
      }
    </script>

    <script>
      const selCliente = document.getElementById("r_cliente");
      const selHab2 = document.getElementById("r_habitacion"); // alias local

      // ANTES estaba sin return; ahora sí esperamos a que termine:
      (async () => {
        await fillSelect(selCliente, "/backend/clientes/opciones.php");
        await fillSelect(selHab2, "/backend/habitaciones/opciones.php");

        // Preseleccionar la primera opción válida y disparar el preview:
        const first = [...selHab2.options].find((o) => o.value);
        if (first) {
          selHab2.value = first.value;
          selHab2.dispatchEvent(new Event("change"));
        }
      })();

      // (temporal) bloquear submit hasta que conectemos crear.php
      // Enviar la reserva al backend
      document
        .getElementById("frmReservar")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const id_cliente = document.getElementById("r_cliente").value;
          const id_habitacion = document.getElementById("r_habitacion").value;
          const check_in = document.getElementById("r_checkin").value;
          const check_out = document.getElementById("r_checkout").value;
          const notas = document.getElementById("r_notas")?.value || "";

          if (!id_cliente || !id_habitacion || !check_in || !check_out) {
            alert("Completa cliente, habitación y fechas.");
            return;
          }

          const fd = new FormData();
          fd.append("id_cliente", id_cliente);
          fd.append("id_habitacion", id_habitacion);
          fd.append("check_in", check_in);
          fd.append("check_out", check_out);
          fd.append("notas", notas);

          try {
            const res = await fetch("/backend/reservaciones/crear.php", {
              method: "POST",
              body: fd,
            });
            const data = await res.json();

            if (!res.ok || !data.ok) {
              alert(data.msg || "No se pudo crear la reservación");
              return;
            }

            alert(`✅ Reservación creada (ID: ${data.id})`);

            // Cambiar a la pestaña "Listado"
            document.querySelector('.tab-btn[data-tab="tab-listado"]').click();

            // Si tienes una función para recargar el listado, llámala aquí (opcional):
            // loadListado();
          } catch (err) {
            console.error(err);
            alert("Error de red al crear la reservación");
          }
        });
    </script>

    <!-- Ver disponibilidad (botón en "Reservar") -->
    <script>
      const btnChecar = document.getElementById("btnChecar");
      btnChecar.addEventListener("click", async () => {
        const inV = document.getElementById("r_checkin").value;
        const outV = document.getElementById("r_checkout").value;
        if (!inV || !outV) {
          alert("Selecciona fechas de check-in y check-out");
          return;
        }

        try {
          const res = await fetch(
            `/backend/reservaciones/disponibles.php?check_in=${encodeURIComponent(
              inV
            )}&check_out=${encodeURIComponent(outV)}`
          );
          const data = await res.json();
          if (!data.ok) {
            alert(data.msg || "Error");
            return;
          }

          const opt = selHab.selectedOptions[0];
          if (opt) {
            const idSel = Number(opt.value);
            const h = data.data.find((x) => x.id_habitacion === idSel);
            if (h) {
              alert(
                h.disponible
                  ? `La habitación #${h.numero} está DISPONIBLE.`
                  : `La habitación #${h.numero} está OCUPADA en ese rango.`
              );
            } else {
              alert(
                "No se encontró la habitación seleccionada en el resultado."
              );
            }
          } else {
            alert(
              'Disponibilidad consultada. Ve la pestaña "Disponibilidad" para listado completo.'
            );
          }
        } catch (e) {
          alert("Error al consultar disponibilidad");
        }
      });
    </script>

    <!-- Pestaña “Disponibilidad” → tabla -->
    <script>
      const dIn = document.getElementById("d_in");
      const dOut = document.getElementById("d_out");
      const dBtn = document.getElementById("d_btnVer");
      const dBody = document.getElementById("d_tbody");

      dBtn.addEventListener("click", async () => {
        const inV = dIn.value;
        const outV = dOut.value;
        if (!inV || !outV) {
          alert("Selecciona el rango de fechas");
          return;
        }

        dBody.innerHTML = `<tr><td colspan="6" class="center muted">Cargando…</td></tr>`;
        try {
          const res = await fetch(
            `/backend/reservaciones/disponibles.php?check_in=${encodeURIComponent(
              inV
            )}&check_out=${encodeURIComponent(outV)}`
          );
          const data = await res.json();
          if (!data.ok) {
            dBody.innerHTML = `<tr><td colspan="6" class="center muted">${
              data.msg || "Error"
            }</td></tr>`;
            return;
          }

          if (!data.data.length) {
            dBody.innerHTML = `<tr><td colspan="6" class="center muted">Sin habitaciones</td></tr>`;
            return;
          }

          dBody.innerHTML = data.data
            .map((h) => {
              const estado = h.disponible
                ? '<span class="badge" style="background:#22c55e;color:#fff">Libre</span>'
                : '<span class="badge" style="background:#ef4444;color:#fff">Ocupada</span>';
              const btn = h.disponible
                ? `<button class="btn btn-primary" data-act="reservar" data-id="${h.id_habitacion}" data-num="${h.numero}">Reservar</button>`
                : `<button class="btn btn-secondary" disabled>No disponible</button>`;

              return `<tr>
            <td>#${h.numero}</td>
            <td>${h.tipo}</td>
            <td>${h.personas}</td>
            <td>$${Number(h.precio).toFixed(2)}</td>
            <td>${estado}</td>
            <td>${btn}</td>
          </tr>`;
            })
            .join("");
        } catch (e) {
          dBody.innerHTML = `<tr><td colspan="6" class="center muted">Error al consultar</td></tr>`;
        }
      });

      // Click en "Reservar" desde disponibilidad → lleva a pestaña Reservar con la habitación preseleccionada
      dBody.addEventListener("click", (e) => {
        const b = e.target.closest('button[data-act="reservar"]');
        if (!b) return;
        const id = b.getAttribute("data-id");
        const tabBtn = document.querySelector(
          '.tab-btn[data-tab="tab-reservar"]'
        );
        tabBtn.click();
        const opt = [...selHab.options].find((o) => o.value === id);
        if (opt) {
          selHab.value = id;
          selHab.dispatchEvent(new Event("change"));
        }
        const inV = dIn.value;
        const outV = dOut.value;
        if (inV) document.getElementById("r_checkin").value = inV;
        if (outV) document.getElementById("r_checkout").value = outV;
      });
    </script>

    <script>
      // === SUBMIT: crear reservación ===
      (function () {
        const frm = document.getElementById("frmReservar");
        const selCliente = document.getElementById("r_cliente");
        const selHab = document.getElementById("r_habitacion");
        const inEl = document.getElementById("r_checkin");
        const outEl = document.getElementById("r_checkout");
        const notasEl = document.getElementById("r_notas");

        // Utilidad: suma extras marcados
        function getExtrasTotal() {
          return [...document.querySelectorAll(".extra:checked")].reduce(
            (acc, e) => acc + Number(e.dataset.precio || 0),
            0
          );
        }

        // Mensaje bonito (puedes cambiar por un modal si prefieres)
        function toast(msg, ok = true) {
          const d = document.createElement("div");
          d.textContent = msg;
          d.style.cssText =
            "position:fixed;left:50%;top:16px;transform:translateX(-50%);" +
            "padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;" +
            (ok
              ? "background:linear-gradient(90deg,#10b981,#22c55e);"
              : "background:linear-gradient(90deg,#ef4444,#f97316);");
          document.body.appendChild(d);
          setTimeout(() => d.remove(), 2500);
        }

        frm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const id_cliente = Number(selCliente.value || 0);
          const id_habitacion = Number(selHab.value || 0);
          const check_in = inEl.value;
          const check_out = outEl.value;
          const notas = (notasEl.value || "").trim();
          const extras_total = getExtrasTotal();

          // Validaciones mínimas en front
          if (!id_cliente) return toast("Selecciona un cliente", false);
          if (!id_habitacion) return toast("Selecciona una habitación", false);
          if (!check_in || !check_out) return toast("Selecciona fechas", false);
          if (check_in >= check_out)
            return toast("El check-out debe ser posterior al check-in", false);

          // Construir payload
          const fd = new FormData();
          fd.append("id_cliente", String(id_cliente));
          fd.append("id_habitacion", String(id_habitacion));
          fd.append("check_in", check_in);
          fd.append("check_out", check_out);
          fd.append("notas", notas);
          fd.append("extras_total", String(extras_total));

          // Llamar al backend
          try {
            const res = await fetch("/backend/reservaciones/crear.php", {
              method: "POST",
              body: fd,
            });
            const data = await res.json().catch(() => null);

            if (!res.ok || !data || data.ok !== true) {
              const msg =
                data && data.msg
                  ? data.msg
                  : `Error al guardar (HTTP ${res.status})`;
              return toast(msg, false);
            }

            // Éxito
            const r = data.data || {};
            toast(
              `Reserva #${r.id_reservacion} creada: Hab ${
                r.id_habitacion
              } · ${r.check_in.slice(0, 10)} → ${r.check_out.slice(0, 10)}`
            );

            // Opcional: limpiar y cambiar a la pestaña "Listado"
            frm.reset();
            // Recalcular totales y preview
            document.getElementById("r_noches").value = "—";
            document.getElementById("r_tarifa").value = "—";
            document.getElementById("r_total").value = "—";

            // Si quieres saltar a Listado:
            // document.querySelector('.tab-btn[data-tab="tab-listado"]').click();
            // (luego conectaremos el listado a su endpoint)
          } catch (err) {
            console.error(err);
            toast("Error de red/servidor al guardar", false);
          }
        });
      })();
    </script>
    <script>
      // --- Listado: cargar con filtros ---
      const lQ = document.getElementById("l_q");
      const lDesde = document.getElementById("l_desde");
      const lHasta = document.getElementById("l_hasta");
      const lEst = document.getElementById("l_estado");
      const lBody = document.getElementById("l_tbody");

      async function cargarListado() {
        const params = new URLSearchParams();
        if (lQ.value.trim() !== "") params.set("q", lQ.value.trim());
        if (lDesde.value) params.set("desde", lDesde.value);
        if (lHasta.value) params.set("hasta", lHasta.value);
        if (lEst.value) params.set("estado", lEst.value);

        lBody.innerHTML =
          '<tr><td class="center muted" colspan="9">Cargando…</td></tr>';

        const res = await fetch(
          "/backend/reservaciones/listar.php?" + params.toString(),
          { headers: { Accept: "text/html" } }
        );
        if (!res.ok) {
          lBody.innerHTML =
            '<tr><td class="center muted" colspan="9">Error al cargar</td></tr>';
          return;
        }
        const html = await res.text();
        lBody.innerHTML =
          html ||
          '<tr><td class="center muted" colspan="9">Sin resultados</td></tr>';
      }

      document
        .getElementById("l_btnBuscar")
        .addEventListener("click", cargarListado);
      document.getElementById("l_btnLimpiar").addEventListener("click", () => {
        lQ.value = "";
        lDesde.value = "";
        lHasta.value = "";
        lEst.value = "";
        cargarListado();
      });

      // Cuando el usuario abra el tab Listado, asegúrate de llamar a cargarListado()
      document
        .querySelector('.tab-btn[data-tab="tab-listado"]')
        .addEventListener("click", cargarListado);
    </script>

    <script>
      // --- Acciones por fila del listado ---
      function toast(msg, ok = true) {
        const d = document.createElement("div");
        d.textContent = msg;
        d.style.cssText =
          "position:fixed;left:50%;top:16px;transform:translateX(-50%);padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;" +
          (ok
            ? "background:linear-gradient(90deg,#10b981,#22c55e);"
            : "background:linear-gradient(90deg,#ef4444,#f97316);");
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 2200);
      }

      lBody.addEventListener("click", async (e) => {
        const b = e.target.closest("button[data-act]");
        if (!b) return;
        const id = b.dataset.id;
        const act = b.dataset.act;

        if (act === "checkin" || act === "checkout") {
          const url =
            act === "checkin"
              ? "/backend/reservaciones/checkin.php"
              : "/backend/reservaciones/checkout.php";
          const fd = new FormData();
          fd.append("id_reservacion", id);
          try {
            const res = await fetch(url, { method: "POST", body: fd });
            const js = await res.json().catch(() => null);
            if (!res.ok || !js || js.ok !== true) {
              toast(js?.msg || "Error", false);
              return;
            }
            toast(js.msg, true);
            cargarListado();
          } catch (err) {
            toast("Error de red", false);
          }
          return;
        }

        if (act === "eliminar") {
          if (
            !confirm(
              "¿Eliminar la reservación? Se borrarán sus cobros/tickets/fechas/servicios ligados."
            )
          )
            return;
          const fd = new FormData();
          fd.append("id_reservacion", id);
          try {
            const res = await fetch("/backend/reservaciones/eliminar.php", {
              method: "POST",
              body: fd,
            });
            const js = await res.json().catch(() => null);
            if (!res.ok || !js || js.ok !== true) {
              toast(js?.msg || "No se pudo eliminar", false);
              return;
            }
            toast(js.msg, true);
            cargarListado();
          } catch (err) {
            toast("Error de red", false);
          }
          return;
        }
      });
    </script>

    <script>
      // --- Acciones en el listado: Check-out y Eliminar ---
      const $lBody = document.getElementById("l_tbody");

      $lBody.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;

        const act = btn.dataset.act;
        const id = btn.dataset.id;

        if (act === "checkout") {
          if (!confirm("¿Registrar check-out ahora?")) return;

          try {
            const fd = new FormData();
            fd.append("id", id);
            const res = await fetch("/backend/reservaciones/checkout.php", {
              method: "POST",
              body: fd,
            });
            const data = await res.json();
            if (!data.ok) {
              alert(data.msg || "No se pudo completar el check-out");
              return;
            }
            // Refrescar listado
            document.getElementById("l_btnBuscar").click();
          } catch (err) {
            alert("Error al registrar check-out");
          }
        }

        if (act === "eliminar") {
          // (Opción ya existente si la tienes; si no, la agregas similar)
          if (!confirm("¿Eliminar esta reservación?")) return;
          try {
            const fd = new FormData();
            fd.append("id", id);
            const res = await fetch("/backend/reservaciones/eliminar.php", {
              method: "POST",
              body: fd,
            });
            const data = await res.json();
            if (!data.ok) {
              alert(data.msg || "No se pudo eliminar");
              return;
            }
            document.getElementById("l_btnBuscar").click();
          } catch {
            alert("Error al eliminar");
          }
        }
      });
    </script>

    <script>
      // --- Helpers de Fechas ---
      function ymd(d) {
        return d.toISOString().slice(0, 10);
      }
      function parseDT(s) {
        return s ? new Date(s.replace(" ", "T")) : null;
      }

      // --- Llenar select Habitación para el filtro (reutilizamos opciones.php) ---
      async function fillHabCalendar() {
        const sel = document.getElementById("c_hab");
        try {
          const res = await fetch("/backend/habitaciones/opciones.php", {
            headers: { Accept: "text/html" },
          });
          const html = await res.text();
          // mantenemos "Todas" y añadimos las opciones
          sel.innerHTML = '<option value="">Todas</option>' + html;
        } catch {
          sel.innerHTML = '<option value="">(Error al cargar)</option>';
        }
      }
      fillHabCalendar();

      // --- Render Calendario (grilla mensual con chips por día) ---
      async function renderCalendar() {
        const shell = document.getElementById("cal_mount");
        const mes = document.getElementById("c_mes").value; // YYYY-MM
        const idh = document.getElementById("c_hab").value; // "" | id
        const tipo = document.getElementById("c_tipo").value; // "" | Tipo

        if (!mes) {
          shell.innerHTML =
            '<div class="center muted">Selecciona un mes y pulsa “Ver”.</div>';
          return;
        }

        const qs = new URLSearchParams({ mes });
        if (idh) qs.set("id_habitacion", idh);
        if (tipo) qs.set("tipo", tipo);

        shell.innerHTML = '<div class="center muted">Cargando…</div>';

        let payload;
        try {
          const res = await fetch(
            "/backend/reservaciones/calendario.php?" + qs.toString()
          );
          payload = await res.json();
        } catch {
          shell.innerHTML =
            '<div class="center muted">Error al consultar</div>';
          return;
        }
        if (!payload.ok) {
          shell.innerHTML =
            '<div class="center muted">' +
            (payload.msg || "Sin datos") +
            "</div>";
          return;
        }

        // Construimos las semanas del mes
        const first = new Date(mes + "-01T00:00:00");
        const year = first.getFullYear();
        const month = first.getMonth(); // 0..11
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // calc qué día de la semana inicia (0=Domingo)
        const startDow = new Date(year, month, 1).getDay();

        // Crear DOM base
        const head = `
      <div class="cal-head">
        <div class="dow">Dom</div><div class="dow">Lun</div><div class="dow">Mar</div>
        <div class="dow">Mié</div><div class="dow">Jue</div><div class="dow">Vie</div><div class="dow">Sáb</div>
      </div>
    `;

        // Preparar contenedor de celdas por semana
        const weeks = [];
        let dayNum = 1 - startDow; // Permite días "vacíos" antes del 1

        while (dayNum <= daysInMonth) {
          const cells = [];
          for (let i = 0; i < 7; i++, dayNum++) {
            if (dayNum < 1 || dayNum > daysInMonth) {
              cells.push(`<div class="day"></div>`);
            } else {
              cells.push(`
            <div class="day" data-date="${year}-${String(month + 1).padStart(
                2,
                "0"
              )}-${String(dayNum).padStart(2, "0")}">
              <span class="n">${dayNum}</span>
              <div class="chips"></div>
            </div>
          `);
            }
          }
          weeks.push(`<div class="cal-row">${cells.join("")}</div>`);
        }

        shell.innerHTML = `<div class="cal-grid"><div class="cal-month">${head}${weeks.join(
          ""
        )}</div></div>`;

        // Pintar chips en los días que caen dentro del rango de cada reserva
        const chipsByDate = {};
        function pushChip(dateStr, html) {
          (chipsByDate[dateStr] ||= []).push(html);
        }

        payload.data.forEach((r) => {
          const inDT = parseDT(r.check_in); // Date
          const outDT = parseDT(r.check_out) || new Date(year, month + 1, 1); // si no hay salida, tomamos fin de mes+1 como tope
          // iterar por días que caen dentro del mes visible
          const cur = new Date(year, month, 1);
          const last = new Date(year, month, daysInMonth, 23, 59, 59);

          // rango para iterar: máx(inDT, firstDay) .. mín(outDT, lastDay)
          const from = new Date(Math.max(inDT.getTime(), cur.getTime()));
          const to = new Date(Math.min(outDT.getTime(), last.getTime()));

          if (to < from) return; // no cruza el mes

          const estado = r.check_out === null ? "En curso" : "Reservada";
          const cls = estado === "En curso" ? "chip--run" : "chip--res";
          const label = `#${r.habitacion} · ${r.cliente}`;

          for (let d = new Date(from); d <= to; d.setDate(d.getDate() + 1)) {
            pushChip(
              ymd(d),
              `<span class="chip ${cls}" title="${label}">${
                "#" + r.habitacion
              }</span>`
            );
          }
        });

        // Volcar chips a las celdas
        Object.entries(chipsByDate).forEach(([dateStr, arr]) => {
          const cell = shell.querySelector(
            `.day[data-date="${dateStr}"] .chips`
          );
          if (cell) cell.innerHTML = arr.join("");
        });
      }

      // Eventos
      document
        .getElementById("c_btnVer")
        .addEventListener("click", renderCalendar);

      // Autoseleccionar el mes actual al abrir la pestaña Calendario (1 sola vez)
      (function initCalendarDefaults() {
        const m = document.getElementById("c_mes");
        if (!m.value) {
          const now = new Date();
          m.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(
            2,
            "0"
          )}`;
        }
      })();
    </script>
  </body>
</html>
