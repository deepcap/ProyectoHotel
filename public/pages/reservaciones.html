<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hotel Paraíso · Reservaciones</title>

    <!-- Estilos base que ya usas -->
    <link rel="stylesheet" href="/public/assets/css/app.css" />
    <link rel="stylesheet" href="/public/assets/css/form.css" />
    <!-- Estilos específicos de reservaciones -->
    <link rel="stylesheet" href="/public/assets/css/reservas.css" />
  </head>
  <body>
    <!-- Topbar -->
    <nav
      class="topbar"
      style="
        background: linear-gradient(90deg, var(--primary-1), var(--primary-2));
      "
    >
      <div class="brand">
        <div class="brand-badge">H</div>
        <div>Hotel&nbsp;Paraíso</div>
      </div>
      <div class="nav-links">
        <a href="/public/index.html">Inicio</a>
        <a href="/public/pages/menu-completo.html">Menú</a>
      </div>
    </nav>

    <!-- Hero “glass” -->
    <header
      class="hero--glass"
      style="
        --hero-bg: url('https://images.pexels.com/photos/258154/pexels-photo-258154.jpeg');
      "
    >
      <div class="glass-card glass-wide">
        <div class="hero-card hero-card--center hero-left">
          <h1 style="margin: 0 0 4px">Reservaciones</h1>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="tab-reservar">
            Reservar
          </button>
          <button class="tab-btn" data-tab="tab-listado">Listado</button>
          <button class="tab-btn" data-tab="tab-disponibilidad">
            Disponibilidad
          </button>
          <div class="right">
            <a class="btn btn-secondary" href="/public/pages/menu-completo.html"
              >← Menú</a
            >
          </div>
        </div>

        <!-- ====== TAB: RESERVAR ====== -->
        <section id="tab-reservar" class="section-card">
          <div class="grid-2">
            <form class="form-grid" id="frmReservar" autocomplete="off">
              <!-- Identificación -->
              <div class="field">
                <label>Cliente</label>
                <select id="r_cliente" required>
                  <option value="">Cargando clientes…</option>
                </select>
              </div>

              <div class="field">
                <label>Habitación</label>
                <select id="r_habitacion" required>
                  <option value="">Cargando habitaciones…</option>
                </select>
              </div>

              <!-- Fechas -->
              <div class="grid-2" style="grid-column: 1/-1">
                <div class="field">
                  <label>Check-in</label>
                  <input type="date" id="r_checkin" required />
                </div>
                <div class="field">
                  <label>Check-out</label>
                  <input type="date" id="r_checkout" required />
                </div>
              </div>

              <!-- Servicios extra -->
              <fieldset class="extras" style="grid-column: 1/-1">
                <legend>Servicios extra (opcional)</legend>
                <div class="extras-grid">
                  <label class="extra-item">
                    <input
                      type="checkbox"
                      class="extra"
                      data-nombre="Desayuno"
                      data-precio="180"
                    />
                    <span>Desayuno buffet</span>
                    <small class="precio">$180</small>
                  </label>
                  <label class="extra-item">
                    <input
                      type="checkbox"
                      class="extra"
                      data-nombre="Spa"
                      data-precio="600"
                    />
                    <span>Acceso Spa</span>
                    <small class="precio">$600</small>
                  </label>
                  <label class="extra-item">
                    <input
                      type="checkbox"
                      class="extra"
                      data-nombre="Transporte"
                      data-precio="350"
                    />
                    <span>Transporte aeropuerto</span>
                    <small class="precio">$350</small>
                  </label>
                  <label class="extra-item">
                    <input
                      type="checkbox"
                      class="extra"
                      data-nombre="Late checkout"
                      data-precio="250"
                    />
                    <span>Late checkout</span>
                    <small class="precio">$250</small>
                  </label>
                </div>
                <p class="muted">* Montos de ejemplo por reservación.</p>
              </fieldset>

              <!-- Cálculos -->
              <div class="grid-3" style="grid-column: 1/-1">
                <div class="field">
                  <label>Noches</label>
                  <input id="r_noches" disabled placeholder="—" />
                </div>
                <div class="field">
                  <label>Tarifa estimada (noche)</label>
                  <input id="r_tarifa" disabled placeholder="—" />
                </div>
                <div class="field">
                  <label>Total estimado</label>
                  <input id="r_total" disabled placeholder="—" />
                </div>
              </div>

              <div class="field" style="grid-column: 1/-1">
                <label>Notas (opcional)</label>
                <textarea
                  id="r_notas"
                  rows="3"
                  placeholder="Instrucciones especiales, comentarios…"
                ></textarea>
              </div>

              <div class="actions actions-wrap">
                <button type="button" class="btn btn-secondary" id="btnChecar">
                  Ver disponibilidad
                </button>
                <button type="submit" class="btn btn-primary">Reservar</button>
              </div>
            </form>

            <!-- Preview tipo de habitación -->
            <aside class="preview">
              <img
                id="prev_img"
                src="https://images.pexels.com/photos/271624/pexels-photo-271624.jpeg"
                alt="Tipo de habitación"
              />
              <div class="preview-body">
                <div class="preview-title" id="prev_titulo">Tipo —</div>
                <div class="muted" id="prev_detalle">
                  Capacidad: — · Precio: —
                </div>
                <div class="legend">
                  <span><i class="c-reservada"></i>Reservada</span>
                  <span><i class="c-checkin"></i>En curso</span>
                  <span><i class="c-checkout"></i>Finalizada</span>
                  <span><i class="c-cancelada"></i>Cancelada</span>
                </div>
              </div>
            </aside>
          </div>
        </section>

        <!-- ====== TAB: LISTADO ====== -->
        <section id="tab-listado" class="section-card" style="display: none">
          <div class="tools">
            <div class="field">
              <label>Buscar</label
              ><input id="l_q" placeholder="Folio, cliente, habitación…" />
            </div>
            <div class="field">
              <label>Desde</label><input type="date" id="l_desde" />
            </div>
            <div class="field">
              <label>Hasta</label><input type="date" id="l_hasta" />
            </div>
            <div class="field">
              <label>Estado</label>
              <select id="l_estado">
                <option value="">Todos</option>
                <option>RESERVADA</option>
                <option>CHECKIN</option>
                <option>CHECKOUT</option>
                <option>CANCELADA</option>
              </select>
            </div>
            <button class="btn btn-secondary" id="l_btnBuscar" type="button">
              Buscar
            </button>
            <button class="btn btn-secondary" id="l_btnLimpiar" type="button">
              Limpiar
            </button>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Cliente</th>
                  <th>Hab.</th>
                  <th>Check-in</th>
                  <th>Check-out</th>
                  <th>Noches</th>
                  <th>Total</th>
                  <th>Estado</th>
                  <th style="width: 220px">Acciones</th>
                </tr>
              </thead>
              <tbody id="l_tbody">
                <tr>
                  <td colspan="9" class="muted center">Sin datos</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- ====== TAB: DISPONIBILIDAD ====== -->
        <section
          id="tab-disponibilidad"
          class="section-card"
          style="display: none"
        >
          <div class="tools">
            <div class="field">
              <label>Check-in</label><input type="date" id="d_in" />
            </div>
            <div class="field">
              <label>Check-out</label><input type="date" id="d_out" />
            </div>
            <button class="btn btn-secondary" id="d_btnVer" type="button">
              Ver disponibilidad
            </button>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Hab.</th>
                  <th>Tipo</th>
                  <th>Capacidad</th>
                  <th>Precio</th>
                  <th>Estado</th>
                  <th style="width: 160px">Acción</th>
                </tr>
              </thead>
              <tbody id="d_tbody">
                <tr>
                  <td colspan="6" class="muted center">Sin datos</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </header>

    <footer class="footer">
      © <span id="y"></span> Hotel Paraíso — Reservaciones
    </footer>

    <script>
      document.getElementById("y").textContent = new Date().getFullYear();

      // Navegación de pestañas
      const tabs = document.querySelectorAll(".tab-btn");
      const sections = {
        "tab-reservar": document.getElementById("tab-reservar"),
        "tab-listado": document.getElementById("tab-listado"),
        "tab-disponibilidad": document.getElementById("tab-disponibilidad"),
      };
      tabs.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabs.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          Object.values(sections).forEach((s) => (s.style.display = "none"));
          sections[btn.dataset.tab].style.display = "";
        });
      });

      // ---- Cálculo simple en front: noches + extras (estimado) ----
      const $in = document.getElementById("r_checkin");
      const $out = document.getElementById("r_checkout");
      const $noches = document.getElementById("r_noches");
      const $tarifa = document.getElementById("r_tarifa");
      const $total = document.getElementById("r_total");

      const IMG_BY_TIPO = {
        Sencilla:
          "https://images.pexels.com/photos/271624/pexels-photo-271624.jpeg",
        Doble:
          "https://images.pexels.com/photos/271618/pexels-photo-271618.jpeg",
        Suite:
          "https://images.pexels.com/photos/1571459/pexels-photo-1571459.jpeg",
        Familiar:
          "https://images.pexels.com/photos/261102/pexels-photo-261102.jpeg",
      };

      const selHab = document.getElementById("r_habitacion");
      const prevImg = document.getElementById("prev_img");
      const prevTit = document.getElementById("prev_titulo");
      const prevDet = document.getElementById("prev_detalle");

      selHab.addEventListener("change", () => {
        const opt = selHab.selectedOptions[0];
        if (!opt) return;
        const tipo = opt.dataset.tipo || "—";
        const cap = opt.dataset.personas || "—";
        const p = opt.dataset.precio || "";
        prevTit.textContent = `Tipo ${tipo}`;
        prevDet.textContent = `Capacidad: ${cap} · Precio: ${
          p ? "$" + Number(p).toFixed(2) : "—"
        }`;
        if (IMG_BY_TIPO[tipo]) prevImg.src = IMG_BY_TIPO[tipo];
        $tarifa.value = p ? "$" + Number(p).toFixed(2) : "—";
        updateTotal();
      });

      [$in, $out].forEach((i) => i.addEventListener("change", updateTotal));
      document
        .querySelectorAll(".extra")
        .forEach((chk) => chk.addEventListener("change", updateTotal));

      function updateTotal() {
        const dIn = $in.value ? new Date($in.value) : null;
        const dOut = $out.value ? new Date($out.value) : null;
        let noches = 0;
        if (dIn && dOut) {
          noches = Math.max(
            0,
            Math.round((dOut - dIn) / (1000 * 60 * 60 * 24))
          );
        }
        $noches.value = noches || "—";

        const opt = selHab.selectedOptions[0];
        const precio =
          opt && opt.dataset.precio ? Number(opt.dataset.precio) : 0;
        const extras = [...document.querySelectorAll(".extra:checked")].reduce(
          (acc, e) => acc + Number(e.dataset.precio || 0),
          0
        );

        let total = 0;
        if (noches > 0 && precio > 0) total = noches * precio + extras;
        else if (extras > 0) total = extras;
        $total.value = total > 0 ? "$" + total.toFixed(2) : "—";
      }
    </script>

    <!-- Llenar combos (con auto-preview) -->
    <script>
      async function fillSelect(sel, url) {
        sel.innerHTML = '<option value="">Cargando…</option>';
        try {
          const res = await fetch(url, { headers: { Accept: "text/html" } });
          const html = await res.text();
          sel.innerHTML = html;
          sel.removeAttribute("disabled");
          sel.style.pointerEvents = "auto";
        } catch (e) {
          sel.innerHTML = '<option value="">(Error al cargar)</option>';
        }
      }
    </script>

    <script>
      const selCliente = document.getElementById("r_cliente");
      const selHab2 = document.getElementById("r_habitacion"); // alias local

      (async () => {
        await fillSelect(selCliente, "/backend/clientes/opciones.php");
        await fillSelect(selHab2, "/backend/habitaciones/opciones.php");

        // Preseleccionar la primera opción válida y disparar el preview:
        const first = [...selHab2.options].find((o) => o.value);
        if (first) {
          selHab2.value = first.value;
          selHab2.dispatchEvent(new Event("change"));
        }
      })();

      // Enviar la reserva al backend
      document
        .getElementById("frmReservar")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const id_cliente = document.getElementById("r_cliente").value;
          const id_habitacion = document.getElementById("r_habitacion").value;
          const check_in = document.getElementById("r_checkin").value;
          const check_out = document.getElementById("r_checkout").value;
          const notas = document.getElementById("r_notas")?.value || "";

          if (!id_cliente || !id_habitacion || !check_in || !check_out) {
            alert("Completa cliente, habitación y fechas.");
            return;
          }

          const fd = new FormData();
          fd.append("id_cliente", id_cliente);
          fd.append("id_habitacion", id_habitacion);
          fd.append("check_in", check_in);
          fd.append("check_out", check_out);
          fd.append("notas", notas);

          try {
            const res = await fetch("/backend/reservaciones/crear.php", {
              method: "POST",
              body: fd,
            });
            const data = await res.json();

            if (!res.ok || !data.ok) {
              alert(data.msg || "No se pudo crear la reservación");
              return;
            }

            alert(`✅ Reservación creada (ID: ${data.id})`);
            document.querySelector('.tab-btn[data-tab="tab-listado"]').click();
            // cargarListado(); // si ya tienes conectada esta función
          } catch (err) {
            console.error(err);
            alert("Error de red al crear la reservación");
          }
        });
    </script>

    <!-- Ver disponibilidad (botón en "Reservar") -->
    <script>
      const btnChecar = document.getElementById("btnChecar");
      btnChecar.addEventListener("click", async () => {
        const inV = document.getElementById("r_checkin").value;
        const outV = document.getElementById("r_checkout").value;
        if (!inV || !outV) {
          alert("Selecciona fechas de check-in y check-out");
          return;
        }

        try {
          const res = await fetch(
            `/backend/reservaciones/disponibles.php?check_in=${encodeURIComponent(
              inV
            )}&check_out=${encodeURIComponent(outV)}`
          );
          const data = await res.json();
          if (!data.ok) {
            alert(data.msg || "Error");
            return;
          }

          const opt = selHab.selectedOptions[0];
          if (opt) {
            const idSel = Number(opt.value);
            const h = data.data.find((x) => x.id_habitacion === idSel);
            if (h) {
              alert(
                h.disponible
                  ? `La habitación #${h.numero} está DISPONIBLE.`
                  : `La habitación #${h.numero} está OCUPADA en ese rango.`
              );
            } else {
              alert(
                "No se encontró la habitación seleccionada en el resultado."
              );
            }
          } else {
            alert(
              'Disponibilidad consultada. Ve la pestaña "Disponibilidad" para listado completo.'
            );
          }
        } catch (e) {
          alert("Error al consultar disponibilidad");
        }
      });
    </script>

    <!-- Pestaña “Disponibilidad” → tabla -->
    <script>
      const dIn = document.getElementById("d_in");
      const dOut = document.getElementById("d_out");
      const dBtn = document.getElementById("d_btnVer");
      const dBody = document.getElementById("d_tbody");

      dBtn.addEventListener("click", async () => {
        const inV = dIn.value;
        const outV = dOut.value;
        if (!inV || !outV) {
          alert("Selecciona el rango de fechas");
          return;
        }

        dBody.innerHTML = `<tr><td colspan="6" class="center muted">Cargando…</td></tr>`;
        try {
          const res = await fetch(
            `/backend/reservaciones/disponibles.php?check_in=${encodeURIComponent(
              inV
            )}&check_out=${encodeURIComponent(outV)}`
          );
          const data = await res.json();
          if (!data.ok) {
            dBody.innerHTML = `<tr><td colspan="6" class="center muted">${
              data.msg || "Error"
            }</td></tr>`;
            return;
          }

          if (!data.data.length) {
            dBody.innerHTML = `<tr><td colspan="6" class="center muted">Sin habitaciones</td></tr>`;
            return;
          }

          dBody.innerHTML = data.data
            .map((h) => {
              const estado = h.disponible
                ? '<span class="badge" style="background:#22c55e;color:#fff">Libre</span>'
                : '<span class="badge" style="background:#ef4444;color:#fff">Ocupada</span>';
              const btn = h.disponible
                ? `<button class="btn btn-primary" data-act="reservar" data-id="${h.id_habitacion}" data-num="${h.numero}">Reservar</button>`
                : `<button class="btn btn-secondary" disabled>No disponible</button>`;

              return `<tr>
              <td>#${h.numero}</td>
              <td>${h.tipo}</td>
              <td>${h.personas}</td>
              <td>$${Number(h.precio).toFixed(2)}</td>
              <td>${estado}</td>
              <td>${btn}</td>
            </tr>`;
            })
            .join("");
        } catch (e) {
          dBody.innerHTML = `<tr><td colspan="6" class="center muted">Error al consultar</td></tr>`;
        }
      });

      // Click en "Reservar" desde disponibilidad → lleva a pestaña Reservar con la habitación preseleccionada
      dBody.addEventListener("click", (e) => {
        const b = e.target.closest('button[data-act="reservar"]');
        if (!b) return;
        const id = b.getAttribute("data-id");
        document.querySelector('.tab-btn[data-tab="tab-reservar"]').click();
        const opt = [...selHab.options].find((o) => o.value === id);
        if (opt) {
          selHab.value = id;
          selHab.dispatchEvent(new Event("change"));
        }
        const inV = dIn.value;
        const outV = dOut.value;
        if (inV) document.getElementById("r_checkin").value = inV;
        if (outV) document.getElementById("r_checkout").value = outV;
      });
    </script>

    <!-- Listado: cargar con filtros -->
    <script>
      const lQ = document.getElementById("l_q");
      const lDesde = document.getElementById("l_desde");
      const lHasta = document.getElementById("l_hasta");
      const lEst = document.getElementById("l_estado");
      const lBody = document.getElementById("l_tbody");

      async function cargarListado() {
        const params = new URLSearchParams();
        if (lQ.value.trim() !== "") params.set("q", lQ.value.trim());
        if (lDesde.value) params.set("desde", lDesde.value);
        if (lHasta.value) params.set("hasta", lHasta.value);
        if (lEst.value) params.set("estado", lEst.value);

        lBody.innerHTML =
          '<tr><td class="center muted" colspan="9">Cargando…</td></tr>';

        const res = await fetch(
          "/backend/reservaciones/listar.php?" + params.toString(),
          { headers: { Accept: "text/html" } }
        );
        if (!res.ok) {
          lBody.innerHTML =
            '<tr><td class="center muted" colspan="9">Error al cargar</td></tr>';
          return;
        }
        const html = await res.text();
        lBody.innerHTML =
          html ||
          '<tr><td class="center muted" colspan="9">Sin resultados</td></tr>';
      }

      document
        .getElementById("l_btnBuscar")
        .addEventListener("click", cargarListado);
      document.getElementById("l_btnLimpiar").addEventListener("click", () => {
        lQ.value = "";
        lDesde.value = "";
        lHasta.value = "";
        lEst.value = "";
        cargarListado();
      });
      document
        .querySelector('.tab-btn[data-tab="tab-listado"]')
        .addEventListener("click", cargarListado);
    </script>

    <!-- Acciones por fila del listado -->
    <script>
      function toast(msg, ok = true) {
        const d = document.createElement("div");
        d.textContent = msg;
        d.style.cssText =
          "position:fixed;left:50%;top:16px;transform:translateX(-50%);padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;" +
          (ok
            ? "background:linear-gradient(90deg,#10b981,#22c55e);"
            : "background:linear-gradient(90deg,#ef4444,#f97316);");
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 2200);
      }

      document
        .getElementById("l_tbody")
        .addEventListener("click", async (e) => {
          const b = e.target.closest("button[data-act]");
          if (!b) return;
          const id = b.dataset.id;
          const act = b.dataset.act;

          if (act === "checkout") {
            if (!confirm("¿Registrar check-out ahora?")) return;
            try {
              const fd = new FormData();
              fd.append("id", id);
              const res = await fetch("/backend/reservaciones/checkout.php", {
                method: "POST",
                body: fd,
              });
              const data = await res.json().catch(() => null);
              if (!res.ok || !data || !data.ok)
                return toast(
                  data?.msg || "No se pudo completar el check-out",
                  false
                );
              toast(data.msg, true);
              cargarListado();
            } catch {
              toast("Error de red", false);
            }
            return;
          }

          if (act === "eliminar") {
            if (!confirm("¿Eliminar esta reservación?")) return;
            try {
              const fd = new FormData();
              fd.append("id", id);
              const res = await fetch("/backend/reservaciones/eliminar.php", {
                method: "POST",
                body: fd,
              });
              const data = await res.json().catch(() => null);
              if (!res.ok || !data || !data.ok)
                return toast(data?.msg || "No se pudo eliminar", false);
              toast(data.msg, true);
              cargarListado();
            } catch {
              toast("Error de red", false);
            }
          }
        });
    </script>
  </body>
</html>
